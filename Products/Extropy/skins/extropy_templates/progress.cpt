<html xmlns="http://www.w3.org/1999/xhtml"
      xml:lang="en"
      lang="en"
      i18n:domain="extropy"
      metal:use-macro="here/main_template/macros/master">
  <head>
  </head>
<body>

<div metal:fill-slot="main" >


<div metal:define-macro="progressreport" 
             tal:define="etool nocall:here/extropy_tracking_tool;
                         tree python:etool.getDeliverablesWithTasks(here)">


    <tal:deliverable tal:repeat="deliverable tree">

        <tal:removeempty condition="deliverable/Type | nothing">
        <script type="text/javascript" tal:content="string:
        handler_${deliverable/UID} = {
            uid: '${deliverable/UID}',
            tasks: $$A(),
            onComplete: function(action) {
                if (action.uid == this.uid) {
                    action.element.up().up().className = 'state-' + action.state;
                    if ($$('deliverables-toc')) {
                        $$('deliverables-toc').descendants().each(function(el) {
                            if (el.tagName.toLowerCase() != 'a') return;
                            if (el.href.endsWith('#' + action.uid)) {
                                el.className = 'state-' + action.state;
                                throw $$break;
                            }
                        })
                    }
                } else if (this.tasks.include(action.uid)) {
                    action.element.up().previous().down('a').className = 'state-' + action.state;
                    WorkflowActions.uids[this.uid].reload();
                }
            }
        };
            WorkflowActions.subscribe(handler_${deliverable/UID}.onComplete.bind(handler_${deliverable/UID}));
        "></script>
        <h2 style="margin-top: 2em"
            tal:attributes="class string:state-${deliverable/review_state};
                            id deliverable/getId">
             <a name="" tal:attributes="name deliverable/UID"></a>
             <img tal:replace="structure here/feature_icon.gif" />
            
                <a tal:attributes="href deliverable/getURL" tal:content="deliverable/Title | nothing"></a>
        <span class="discreet" 
              tal:condition="deliverable/end"
              tal:content="string:(${deliverable/end})">
         (2007/03/11)
        </span>
        <span tal:define="deliverable_obj deliverable/getObject"
              tal:content="structure deliverable_obj/@@workflowactions"/>
        
        </h2>

        <tal:progressbar define="
                         worked deliverable/getWorkedHours;
                         estimated deliverable/getEstimatedDuration; 
                         URL deliverable/getURL;
                         remaining deliverable/getRemainingTime;
                         bar nocall:context/@@smallprogressbar">  
            <a tal:replace="structure python:bar(URL=URL,remaining=remaining,  worked=worked)">
            </a>  
        </tal:progressbar>



        <form tal:attributes="action string:${deliverable/getURL}/createObject"
              method="post"
               style="float:right">
              <input type="hidden" name="type_name" value="ExtropyTask">
              <button style="padding: 3px 0 2px 0; margin: -1px 0 1px 1em" type="submit"><img tal:replace="structure here/add_icon.gif" /> Add Task </button>
        </form>
        <form tal:attributes="action string:${deliverable/getURL}/tasks_batchadd"
              method="post"
               style="float:right">
              <button style="padding: 3px 0 2px 0; margin: -1px 0 1px 1em" type="submit"><img tal:replace="structure here/add_alternative_icon.gif" /> Batch Add </button>
        </form>

        <table class="vertical listing" style="float:right; margin-top:0;">
            <tr>
                <th>Responsible</th>
                <td tal:define="responsible deliverable/getResponsiblePerson;
                                author python:responsible and mtool.getMemberInfo(responsible);
                                name author/fullname|responsible"
                    tal:content="python:name or default">
                    <span style="color: red">Nobody</span> (<a href="" tal:attributes="href string:${deliverable/getURL}/edit">Change</a>)
                </td>
            </tr>
        </table>
                        
        </tal:removeempty>

        <div class="visualClear"></div>


        <!--  CHILD TASKS  -->

        <table class="listing" style="width: 100%; margin-bottom: 2em"
               tal:condition="deliverable/children">
            <tr>
                <th>Task</th>
                <th>Status</th>
                <th>Responsible</th>
                <th>Work</th>
            </tr>
            
            <tal:tasks repeat="task deliverable/children | nothing">
            <tr tal:attributes="class string:${repeat/task/parity}">
                <td>
                    <img tal:replace="structure here/task_icon.gif" />
                
                    <a tal:attributes="href task/getURL;
                                       class string:state-${task/review_state}" 
                       tal:content="task/Title|nothing"
                       >Task title</a> 
                </td>
                <td tal:define="task_obj task/getObject"
                    tal:content="structure task_obj/@@workflowactions">
                </td>
                <td>
                    <select class="notImplemented">
                        <option tal:define="responsible task/getResponsiblePerson;
                                            author python:responsible and mtool.getMemberInfo(responsible)"
                                tal:content="author/fullname|responsible">Responsible</option>
                        <option>Not impl</option>
                    </select>
                </td>
                <td tal:define="remaining task/getRemainingTime | nothing">

                    <!-- <span tal:condition="remaining"><span tal:replace="remaining" />h</span>
                    <select class="notImplemented"
                            tal:define="est task/getEstimatedDuration" tal:condition="not:est">
                        <option >No estimate</option>
                        <option>Not implem.</option>
                    </select>
                -->
                    <tal:progressbar define="
                         worked task/getWorkedHours;
                         estimated task/getEstimatedDuration; 
                         URL task/getURL;
                         remaining task/getRemainingTime;
                         bar nocall:context/@@smallprogressbar">  
                <a tal:replace="structure python:bar(URL=URL,remaining=remaining,  worked=worked)">
                </a>  
        </tal:progressbar>


                </td>
                
             </tr>
             <script type="text/javascript" tal:content="string:
                handler_${deliverable/UID}.tasks.push('${task/UID}');
             "></script>
             </tal:tasks>
             
             <tr style="border-top: 1px solid #999">
                 <td colspan="4">
                     <form class="notImplemented"
                           style="text-align: right;">
                         <input type="submit" class="context" value="Save changes" />
                     </form>
                    
                 </td>
             </tr>
        </table>


        
    </tal:deliverable>

</div>

</div>
</body>
</html>
