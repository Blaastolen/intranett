<html xmlns="http://www.w3.org/1999/xhtml"
      xml:lang="en"
      lang="en"
      i18n:domain="extropy"
      metal:use-macro="here/main_template/macros/master">

<head></head>

<body>

<div metal:fill-slot="main">

    <h1 tal:content="context/Title" />

    <div class="visualClear"><!----></div>

    <div style="float: right">
        <button type="button"
                tal:attributes="onclick string:window.location.href='${here/absolute_url}/add_work_hours'">
            <img tal:replace="structure here/hour_icon.gif" />
            Register work hours
        </button>
    </div>

    <div tal:define="worked here/getWorkedHours;
                     URL here/absolute_url;
                     bar nocall:context/@@progressbar">
        <a tal:replace="structure python:bar(URL=URL, worked=worked)"></a>
    </div>

    <dl id="parentdata" class="collapsible collapsedOnLoad"
        tal:define="deliverable here/getOriginatingFeature">
        <dt class="collapsibleHeader">Parent deliverable &quot;<span tal:replace="deliverable/Title"></span>&quot;</dt>
        <dd class="collapsibleContent"><p tal:replace="structure deliverable/getText"></p></dd>
        <dd class="collapsibleContent">
            <table class="vertical listing">
                <tr>
                    <th>Sibling tasks</th>
                    <td tal:define="deliverable here/getOriginatingFeature;
                                    etool nocall:here/extropy_tracking_tool;
                                    tasks python:etool.trackingQuery(deliverable, meta_type='ExtropyTask', REQUEST=request);">
                        <div tal:repeat="task tasks">
                            <a tal:attributes="href task/getURL;
                                               class string:state-${task/review_state};"
                               tal:content="task/Title">
                                Task
                            </a>
                        </div>
                    </td>
                </tr>
            </table>
        </dd>
    </dl>

    <h2>Status</h2>

    <table class="vertical listing" style="float: right; margin: 1em">
        <tbody>
            <tr>
                <th>Priority</th>
                <td>
                    <span tal:content="here/getPriorityDescription">Urgent</span>
                </td>
            </tr>
            <tr>
                <th>Active after</th>
                <td>
                    <span tal:condition="here/start"
                          tal:content="python:here.start().strftime('%d %b')"></span>
                </td>
            </tr>
            <tr>
                <th>Due Date</th>
                <td>
                    <span tal:condition="here/end"
                          tal:content="python:here.end().strftime('%d %b')"></span>
                </td>
            </tr>
            <tr>
                <th>Responsible</th>
                <td>
                    <span tal:define="responsible here/getResponsiblePerson;
                                      author python:responsible and mtool.getMemberInfo(responsible)"
                          tal:content="author/fullname|responsible"
                          >limi</span>
                </td>
            </tr>
            <tr>
                <th>Nosy list</th>
                <td>
                    <tal:participants repeat="participant here/getParticipants">
                        <span tal:define="author python:mtool.getMemberInfo(participant);
                                          name author/fullname|participant"
                              tal:replace="name">limi</span><span
                              tal:condition="not:repeat/participant/end"
                              tal:omit-tag="">,</span>
                    </tal:participants>
                </td>
            </tr>
        </tbody>
    </table>

    <div tal:define="text context/getText;
                     content python:text and text or default"
         tal:content="structure content"></div>

    <div class="visualClear"><!----></div>

    <table metal:define-macro="historylist"
           tal:define="history here/getHistory"
           tal:condition="history"
           tal:on-error="nothing"
           class="vertical listing" style="width: 100%">

        <tr>
            <th>Comment</th>
            <th>Changes</th>
        </tr>

        <tal:changes tal:repeat="changes python:history">
            <tr tal:define="oddrow repeat/changes/odd"
                tal:attributes="class python:test(oddrow, 'even', 'odd')">
                <td style="width: 70%">
                    <p style="text-align:center; color: #666">
                        <span tal:define="creator changes/Creator | nothing;
                                          creatordata python:mtool.getMemberInfo(creator)">
                            <b tal:condition="creatordata" tal:content="python:creatordata['fullname'] or creator">Author</b>
                            <b tal:condition="not:creatordata" tal:content="creator">Author</b>
                        </span>
                        on
                        <span tal:replace="python:toLocalizedTime(changes.created())">Date</span>
                    </p>
                    <div tal:content="structure changes/getChangenote">
                        Change note
                    </div>
                </td>
                <td style="width: 30%">
                    <tal:change repeat="change changes/getChanges | nothing">
                        <div>
                            <b tal:content="change/title">Priority</b>
                            <del tal:content="change/from">Old value</del>
                            <ins tal:content="change/to">New value</ins>
                        </div>
                    </tal:change>
                </td>
            </tr>
        </tal:changes>
    </table>

    <div metal:use-macro="here/extropyproject_view/macros/contentlisting"></div>

</div>
</body>
</html>
