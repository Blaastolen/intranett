# Generated by buildout based on templates/jarn.conf

upstream backends {
    server localhost:8080;
}

server {
    listen ${nginx-conf:ip-address}:80;

    server_name ${nginx-conf:domain};

    rewrite ^(.*)$ https://${nginx-conf:domain}$1 permanent;
}

server {
    listen ${nginx-conf:ip-address}:443;

    ssl on;
    ssl_certificate ${buildout:directory}/etc/ssl/STAR_intranett_no.ca-bundle;
    ssl_certificate_key ${buildout:directory}/etc/ssl/STAR_intranett_no.key;

    # Use HTTP Strict Transport Security to force client to use secure
    # connections only (for the next 5 days). add_header only operates
    # on 200, 204, 301, 302 or 304 responses
    add_header Strict-Transport-Security max-age=432000;

    client_max_body_size 10m;
    server_name ${nginx-conf:domain};
    access_log /var/log/nginx/${nginx-conf:domain}_access.log;

    error_page 500 502 503 504  /500.html;

    location /500.html {
        root ${buildout:directory}/nginx-sites/errors;
    }

    location /under_construction.jpg {
        root ${buildout:directory}/nginx-sites/errors;
    }

    location / {
        proxy_pass http://backends/VirtualHostBase/https/${nginx-conf:domain}:443/Plone/VirtualHostRoot/;
    }
}
