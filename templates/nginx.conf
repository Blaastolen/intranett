# Generated by buildout based on templates/jarn.conf

upstream backends {
    server localhost:8080;
}

server {
    listen ${nginx-conf:ip-address}:80 default_server;

    server_name ${nginx-conf:domain};

    rewrite ^(.*)$ https://${nginx-conf:domain}$1 permanent;
}

server {
    listen ${nginx-conf:ip-address}:443 default_server ssl;

    ssl_certificate ${buildout:directory}/etc/ssl/STAR_intranett_no.ca-bundle;
    ssl_certificate_key ${buildout:directory}/etc/ssl/STAR_intranett_no.key;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    gzip_comp_level 2;
    gzip_buffers 16 8k;
    gzip_types text/plain text/xml application/xml application/xml+rss
        text/css text/javascript application/javascript font/woff
        application/x-javascript application/json image/svg+xml font/truetype
        font/opentype application/vnd.ms-fontobject text/x-component;

    # Use HTTP Strict Transport Security to force client to use secure
    # connections only (for the next 5 days). add_header only operates
    # on 200, 204, 301, 302 or 304 responses
    add_header Strict-Transport-Security max-age=432000;

    # Enable clickjacking protection in modern browsers. Available in
    # IE8 also. See
    # https://developer.mozilla.org/en/The_X-FRAME-OPTIONS_response_header
    add_header X-Frame-Options SAMEORIGIN;

    client_max_body_size 10m;
    server_name ${nginx-conf:domain};
    access_log /var/log/nginx/${nginx-conf:domain}_access.log;

    error_page 500 502 503 504  /500.html;

    types {
        text/cache-manifest                   manifest;
        image/svg+xml                         svg svgz;
        image/webp                            webp;
        image/vnd.microsoft.icon              ico;
        application/octet-stream              safariextz
        video/mp4                             mp4;
        video/ogg                             ogv;
        video/webm                            webm;
        application/vnd.ms-fontobject         eot;
        font/truetype                         ttf;
        font/opentype                         otf;
        font/woff                             woff;
    }

    location /500.html {
        root ${buildout:directory}/nginx-sites/errors;
    }

    location /under_construction.jpg {
        root ${buildout:directory}/nginx-sites/errors;
    }

    location ~* \.(eot|otf|ttf|woff)$ {
        add_header Access-Control-Allow-Origin *;
    }

    location / {
        proxy_pass http://backends/VirtualHostBase/https/${nginx-conf:domain}:443/${nginx-conf:ploneid}/VirtualHostRoot/;
    }
}
