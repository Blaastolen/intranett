var pb={spinner:{},overlay_counter:1};jQuery.tools.overlay.conf.oneInstance=false;jQuery(function(a){pb.spinner.show=function(){a("body").css("cursor","wait")};pb.spinner.hide=function(){a("body").css("cursor","")};a.fn.prepOverlay=function(b){return this.each(function(){var i,j,c,g,d,h,f;i=a(this);j=a.extend(true,{},b);c=j.config||{};g=pb[j.subtype];if(g){c.onBeforeLoad=g}d=c.onLoad;c.onLoad=function(){if(d){d.apply(this,arguments)}pb.fi_focus(this.getOverlay())};h=i.attr("href")||i.attr("src")||i.attr("action");if(j.urlmatch){h=h.replace(new RegExp(j.urlmatch),j.urlreplace)}if(j.subtype==="inline"){h=h.replace(/^.+#/,"#");a("[id='"+h.replace("#","")+"']").addClass("overlay");i.removeAttr("href").attr("rel",h);i.overlay()}else{j.nt="pb_"+pb.overlay_counter;pb.overlay_counter+=1;j.selector=j.filter||j.selector;if(!j.selector){f=h.split(" ");h=f.shift();j.selector=f.join(" ")}j.src=h;j.config=c;pb.remove_overlay(i);i.data("pbo",j);i.attr("rel","#"+j.nt);i.addClass("link-overlay");switch(j.subtype){case"image":i.click(pb.image_click);break;case"ajax":i.click(pb.ajax_click);break;case"iframe":pb.create_content_div(j);i.overlay(c);break;default:throw"Unsupported overlay type"}i.css("cursor","pointer")}})};pb.remove_overlay=function(c){var b=c.data("pbo");if(b){switch(b.subtype){case"image":c.unbind("click",pb.image_click);break;case"ajax":c.unbind("click",pb.ajax_click);break;default:c.unbind("click")}if(b.nt){a("#"+b.nt).remove()}}};pb.create_content_div=function(c){var b;b=a('<div id="'+c.nt+'" class="overlay overlay-'+c.subtype+" "+(c.cssclass||"")+'"><div class="close"><span>Close</span></div></div>');b.data("pbo",c);if(c.width){b.width(c.width)}b.appendTo(a("body"));return b};pb.image_click=function(h){var c,g,f,b,d,i;c=a(this);i=c.data("pbo");g=a(c.attr("rel"));if(!g.length){g=pb.create_content_div(i);g.overlay(i.config)}f=g.overlay();if(g.find("img").length===0){if(i.src){pb.spinner.show();b=new Image();b.src=i.src;d=a(b);g.append(d.addClass("pb-image"));d.load(function(){pb.spinner.hide();f.load()})}}else{f.load()}return false};pb.fi_focus=function(b){if(!b.find("form div.error :input:first").focus().length){b.find("form :input:visible:first").focus()}};pb.ajax_error_recover=function(d,b){var c=a("<div/>").append(d.replace(/<script(.|\s)*?\/script>/gi,""));return b?c.find(b):c};pb.add_ajax_load=function(b){if(b.find("input[name=ajax_load]").length===0){b.prepend(a('<input type="hidden" name="ajax_load" value="'+(new Date().getTime())+'" />'))}};pb.prep_ajax_form=function(b){var l=b.closest(".pb-ajax"),k=l.closest(".overlay-ajax"),g=k.data("pbo"),d=g.formselector,j=g.closeselector,n=g.beforepost,h=g.afterpost,c=g.noform,i=k.overlay(),f=g.selector,m={};m.beforeSerialize=function(){pb.spinner.show()};if(n){m.beforeSubmit=function(o,q,p){return n(q,o,p)}}m.success=function(q,s,v,p){a(document).trigger("formOverlayStart",[this,q,s,v,p]);var o,u,t,r;t=s==="success"||s==="notmodified";if(!t){q=q.responseText}q=q.replace(/<script(.|\s)*?\/script>/gi,"");o=a("<div />").append(f?a("<div />").append(q).find(f):q);if(t&&h){h(o,k)}u=o.find(d);if(t&&u.length){l.empty().append(o);pb.fi_focus(l);pb.add_ajax_load(u);u.ajaxForm(m);if(j){o.find(j).click(function(w){i.close();return false})}a(document).trigger("formOverlayLoadSuccess",[this,u,i,pb,l])}else{if(t){if(typeof(c)==="function"){c=c(this)}}else{c=s}switch(c){case"close":i.close();break;case"reload":i.close();pb.spinner.show();location.replace(location.href);break;case"redirect":i.close();pb.spinner.show();r=g.redirect;if(typeof(r)==="function"){r=r(this,q)}location.replace(r);break;default:if(o.children()){l.empty().append(o)}else{i.close()}}a(document).trigger("formOverlayLoadFailure",[this,u,i,pb,l,c])}pb.spinner.hide()};m.error=m.success;pb.add_ajax_load(b);b.ajaxForm(m)};pb.ajax_click=function(d){var c=a(this),i,k,j,b,f,h,g,l,m;e=a.Event();e.type="beforeAjaxClickHandled";a(document).trigger(e,[this,d]);if(e.isDefaultPrevented()){return}i=c.data("pbo");k=pb.create_content_div(i);k.overlay(i.config);j=k.overlay();b=i.src;h=i.selector;g=i.formselector;l=i.closeselector;pb.spinner.show();a(this).find("input.submitting").removeClass("submitting");f=a('<div class="pb-ajax" />');if(j.getConf().fixed){f.css("max-height",Math.floor(a(window).height()*0.75))}k.append(f);m=(b.indexOf("?")>=0)?"&":"?";b+=m+"ajax_load="+(new Date().getTime());if(h){b+=" "+h}f[0].handle_load_inside_overlay=function(p,n){var o=a(this);if(n==="error"){o.append(pb.ajax_error_recover(p,h))}else{if(!p.length){o.append(ajax_noresponse_message||"No response from server.")}}o.wrapInner("<div />");if(g){var q=o.find(g);if(q.length>0){pb.prep_ajax_form(q)}}if(l){o.find(l).click(function(r){j.close();return false})}if(a.fn.ploneTabInit){o.ploneTabInit()}j.onClose=function(){k.remove()};a(document).trigger("loadInsideOverlay",[this,p,n,j])};f.load(b,null,function(o,n){f[0].handle_load_inside_overlay.apply(this,[o,n]);pb.spinner.hide();j.load();return true});return false};pb.iframe=function(){var b,c;pb.spinner.show();b=this.getOverlay();c=this.getTrigger().data("pbo");if(b.find("iframe").length===0&&c.src){b.append('<iframe src="'+c.src+'" width="'+b.width()+'" height="'+b.height()+'" onload="pb.spinner.hide()"/>')}else{pb.spinner.hide()}return true}});