[buildout]
extends =
    cfgs/base.cfg

prod-parts =
    env
    grp
    zeo
    instance1
    instance2
    atct_conf
    instance-debug
    haproxy
    haproxy-conf
    nginx-conf
    logrotate

cron-parts = 
    backup-cronjob
    zeopack-crontab
    logrotate-crontab

parts =
    ${buildout:base-parts}
    ${buildout:prod-parts}
    ${buildout:varnish-parts}
    ${buildout:cron-parts}
    ${buildout:supervisor-parts}
    supervisor-initd

develop =
    src/intranett.policy
    src/intranett.theme
    src/intranett.tour
    src/intranett.task


[zeo]
recipe = plone.recipe.zeoserver
zeo-address = 127.0.0.1:8001
blob-storage = ${buildout:directory}/var/blobstorage
authentication-realm = intranett
authentication-database = ${buildout:directory}/etc/auth.db
pack-days = 7
pack-keep-old = false
pack-user = zeointranett
pack-password = FuGwjSm32eCaOX

[backup-cronjob]
recipe = z3c.recipe.usercrontab
times = 37 2 * * *
command = ${buildout:directory}/bin/backup --quiet

[zeopack-crontab]
recipe = z3c.recipe.usercrontab
times = 47 1 * * *
command = ${buildout:bin-directory}/zeopack

[instance-base]
user = ${credentials:zope-user}
zeo-client = True
zeo-address = ${zeo:zeo-address}
zeo-realm = ${zeo:authentication-realm}
blob-storage = ${zeo:blob-storage}
shared-blob = on
zeo-username = zeointranett
zeo-password = FuGwjSm32eCaOX
zserver-threads = 1
http-fast-listen = off
environment-vars +=
    INTRANETT_PLONE_ID ${env:INTRANETT_PLONE_ID}
mailinglogger =
  <mailing-logger>
    level error
    flood-level 10
    smtp-server mail.gocept.net
    from logger@intranett.no
    to hosting@jarn.com
    subject [intranett.no error] [%(hostname)s] %(line)s
  </mailing-logger>

[instance1]
<= instance-base
http-port = ${ports:instance1-http-port}
http-address = 127.0.0.1:${ports:instance1-http-port}

[instance2]
<= instance-base
http-port = ${ports:instance2-http-port}
http-address = 127.0.0.1:${ports:instance2-http-port}

[instance-debug]
<= instance-base
http-port = 8090
http-address = 127.0.0.1:8090
verbose-security = on

[atct_conf]
recipe = plone.recipe.command
target1 = ${instance1:location}/etc/atcontenttypes.conf
target2 = ${instance2:location}/etc/atcontenttypes.conf
command = ln -s ${buildout:directory}/etc/atcontenttypes.conf ${:target1} ; ln -s ${buildout:directory}/etc/atcontenttypes.conf ${:target2}

[zopepy]
eggs = ${instance1:eggs}

[haproxy]
recipe = plone.recipe.haproxy
url = http://dist.jarn.com/public/haproxy-1.4.15.zip

[haproxy-conf]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/haproxy.cfg
output = ${buildout:directory}/etc/haproxy.cfg
user = ${env:USER}
group = ${grp:GROUP}
frontend-host = 127.0.0.1
frontend-port = 8010

[nginx-conf]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/nginx.conf
output = ${buildout:directory}/nginx-sites/jarn.conf
ip-address = ${env:INTRANETT_ZOPE_IP}
ploneid = ${env:INTRANETT_PLONE_ID}

[supervisor-initd]
recipe = plone.recipe.command
target = ${buildout:directory}/etc/init.d
command =
    [ ! -e /var/spool/init.d ] && mkdir /var/spool/init.d || echo
    [ ! -e /var/spool/init.d/jarn ] && mkdir /var/spool/init.d/jarn || echo
    chmod a+x ${:target}/10supervisord
    ln -s ${:target}/10supervisord /var/spool/init.d/jarn/10supervisord

[logrotate]
recipe = collective.recipe.template
input =  ${buildout:directory}/templates/logrotate.conf
output = ${buildout:directory}/etc/logrotate.conf

[logrotate-crontab]
recipe = z3c.recipe.usercrontab
times = 57 23 * * *
command = /usr/sbin/logrotate -s ${buildout:directory}/var/logrotate.status ${buildout:directory}/etc/logrotate.conf
